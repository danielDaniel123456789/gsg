<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Insertar y Listar Usuarios</title>

    <meta name="description" content="Juan Santamaria">

    <meta name="theme-color" content="#f8f9f9">
    <meta name="MobileOptimized" content="width">
    <meta name="HandheldFriendly" content="true">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="shortcut icon" type="image/png" href="./img/logo.png">
    <link rel="apple-touch-icon" href="./img/logo.png">
    <link rel="apple-touch-startup-image" href="./img/logo.png">
    <link rel="manifest" href="./manifest.json">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <style>
        .swal2-popup.swal2-modal.swal2-show {
            background-color: #d5dbdb;
        }

        .header {
            position: absolute;

            left: 10px;
            top: 30px;
            z-index: 5;


        }

        #titulo {
            color: #d5dbdb;
            z-index: -1 !important;
            padding-top: 20px;
        }



        .avatar {
            width: 30px;
            height: 30px;

            border-radius: 50%;
            z-index: 8 !important;


        }

        /* Si quieres un avatar con una imagen, usa esto */






        #menuopcionesDropdown {
            position: fixed;
            right: 10px;
            top: 10px;
            color: white;
            text-align: center;
            z-index: 8 !important;
        }



        body {
            background-color: #fbfcfc;
        }



        #cargarDetalles {
            overflow-y: auto;
            padding-left: 10px;
            padding-right: 10px;
            margin-top: 10px;
            margin-bottom: 10px;
            display: none;
        }

        .iconoPrincipal {
            padding-top: 10px;
            font-weight: 200;
        }

        .swal2-container.swal2-center.swal2-backdrop-show {
            background-color: #fbfcfc;
        }
    </style>

    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
        import {
            writeBatch,
            getFirestore,
            collection,
            addDoc,
            getDocs,
            doc,
            getDoc,
            updateDoc,
            arrayUnion,
            deleteDoc // Asegúrate de agregar esta línea
        } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyCFD4r3002vUWFNwhsu-XA4H_s65n-zo6I",
            authDomain: "dbgsg-8b40d.firebaseapp.com",
            projectId: "dbgsg-8b40d",
            storageBucket: "dbgsg-8b40d.appspot.com",
            messagingSenderId: "769712986800",
            appId: "1:769712986800:web:c100a6fcc6d2f704f6f975",
            measurementId: "G-TBQH07LB1E"
        };
        let isEditHoursModalOpen = false; // Bandera para controlar si el modal principal está abierto
        let isEditHoursModalActive = false;
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function addUser(name, password, cedula) {
            try {
                if (!name || !password || !cedula) {
                    return Swal.fire("Error", "Por favor, completa todos los campos.", "error");
                }

                const docRef = await addDoc(collection(db, "usuarios"), {
                    name,
                    contraseya: password,
                    cedula, // Se agrega el campo cédula
                    horas: [] // Inicializa el array de horas vacías
                });

                Swal.fire("Éxito", `Usuario agregado con ID: ${docRef.id}`, "success");
                reproducirAudio();
                cargarDatos(); // Actualizar la tabla
            } catch (e) {
                console.error("Error al agregar documento: ", e);
            }
        }


        async function cargarDatos() {

            cargarHeader();
            showLoading(); // Mostrar indicador de carga
            try {
                const tableBody = document.getElementById("user-table-body");
                tableBody.innerHTML = ""; // Limpiar la tabla

                const querySnapshot = await getDocs(collection(db, "usuarios"));
                querySnapshot.forEach((doc) => {
                    const horas = Array.isArray(doc.data().horas) ?
                        doc.data().horas
                            .map(
                                (h, index) =>
                                    `${h.horas} (${h.periodo}) - ${new Date(h.fecha).toLocaleString()} `
                            )
                            .join("<br>") :
                        "No hay horas registradas"; // Mostrar las horas registradas

                    const row = document.createElement("tr");
                    row.innerHTML = `
       
     <td class="text-primary"><i class="fa fa-user" aria-hidden="true"></i> ${truncate(doc.data().name, 12)}</td>

     
      
        <td>
           <button class="btn btn-primary" onclick="showEditHoursModal('${doc.id}', '${doc.data().name}')"><i class="fa fa-building" aria-hidden="true"></i></button>
          <button class="btn btn-warning" onclick="showHoursModal('${doc.id}', '${doc.data().name}')"><i class="fa fa-calculator" aria-hidden="true"></i></button>
          <button hidden class="btn btn-danger" onclick="deleteUser('${doc.id}')">Eliminar</button>
        </td>
      `;

                    tableBody.appendChild(row);
                });
            } catch (e) {
                console.error("Error al obtener documentos: ", e);
                Swal.fire("Error", "Hubo un problema al cargar los usuarios.", "error");
            } finally {
                Swal.close(); // Cerrar indicador de carga
            }
        }

        function showLoading() {

            Swal.fire({
                title: 'Cargando...',
                text: 'Por favor espera.',
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        }

        function cerrarInformeGenereal() {
            document.getElementById("misUsuarios").style.display = "block";
            document.getElementById("cargarDetalles").style.display = "none";

            //document.getElementById("menu01").style.display = "block"; 
        }

        function mostrarDetalles() {
            const menu01 = document.getElementById("menu01");
            const misUsuarios = document.getElementById("misUsuarios");
            const cargarDetalles = document.getElementById("cargarDetalles");

            if (menu01) menu01.style.display = "none";
            if (misUsuarios) misUsuarios.style.display = "none";
            if (cargarDetalles) cargarDetalles.style.display = "block";
        }

        function showEditHoursModal(userId, name) {
            let miArray = [];
            let calcularSuma = 0;

            Swal.fire({
                title: "Ingrese su Contraseña",
                input: "password",
                inputPlaceholder: "Escriba su contraseña",
                showCancelButton: true,
                confirmButtonText: "Ingresar",
                cancelButtonText: "Cancelar",
                allowOutsideClick: false,
                allowEscapeKey: false,
                /*
                preConfirm: (password) => {
                    return new Promise((resolve, reject) => {
                        const userRef = doc(db, "usuarios", userId);
                        getDoc(userRef)
                            .then((userDoc) => {
                                if (userDoc.exists()) {
                                    const userData = userDoc.data();
                                    const storedPassword = userData.contraseya;
        
                                    if (password.trim() === storedPassword.trim()) {
                                        resolve();
                                    } else {
                                        reject("Contraseña incorrecta");
                                    }
                                } else {
                                    reject("Usuario no encontrado");
                                }
                            })
                            .catch((error) => {
                                console.error("Error al verificar la contraseña:", error);
                                reject("Error al verificar la contraseña");
                            });
                    });
                },
                */
            })
                .then((result) => {
                    if (result.isConfirmed) {
                        // Aquí continúa la lógica si la contraseña es correcta
                        document.getElementById("misUsuarios").style.display = "none";
                        document.getElementById("cargarDetalles").style.display = "block";
                        console.log(userId);

                        getDoc(doc(db, "usuarios", userId))
                            .then((userDoc) => {
                                if (userDoc.exists()) {
                                    //  const horas = userDoc.data().horas || [];
                                    const horas = Array.isArray(userDoc.data().horas) ? userDoc.data().horas : [userDoc.data().horas];

                                    const periodRates = {
                                        "Normal ₡1494.31": 1400.31,
                                        "Diurnas ₡2241.31 (5:00am a las 19:00pm)": 2241.31,
                                        "Mixtas ₡2561.50 (19:00 a las 22:00)": 2561.5,
                                        "Nocturnas ₡2988.41 (22:00 a las 5:00am)": 2988.41,
                                    };

                                    let horasOptions = `
                        <div class="container">
                            <table class="table table-striped" style="width: 100%">
                                <thead>
                                    <tr>
                                        <th>Horas</th>
                                        <th>Modificar</th>
                                        <th>Aerolinea</th>
                                        <th>Motivo</th>
                                        <th>Fecha</th>
                                        <th>Hora Inicio</th>
                                        <th>Hora Final</th>
                                        <th>Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody id="hours-table-body">`;

                                    let totalHoras = 0;
                                    let totalSubtotal = 0;
                                    console.log(horas);
                                    horas.forEach((h, index) => {
                                        const isEditable = index === horas.length - 1; // Solo la última fila es editable
                                        const date = new Date(h.fecha);
                                        const formattedDate = h.fecha ? date.toISOString().split("T")[0] : "";
                                        const formattedTime = h.hora || "00:00";
                                        const rate = periodRates[h.periodo] || 0;

                                        // Extraemos solo el número de la columna 'Inserto'
                                        const insertValue = h.periodo ? h.periodo.replace(/\(.*?\)/g, "").trim() : "0";
                                        const subtotal = parseFloat(insertValue) || 0;

                                        // Acumula las horas y subtotales de todas las filas
                                        totalHoras += h.horas || 0;
                                        totalSubtotal += subtotal;

                                        // Agregar a la tabla
                                        horasOptions += `
                            <tr>
                                <td data-label="Horas">
                                    <input type="number" id="edit-hours-${index}" class="form-control" value="${h.horas || ""}" oninput="updateSubtotal(${index})" ${isEditable ? "" : "disabled"}>
                                </td>
                                <td data-label="Modificar">
                                    <select id="edit-period-${index}" class="form-control" onchange="updateSubtotal(${index})" ${isEditable ? "" : "disabled"}>
                                        ${Object.keys(periodRates).map((period) =>
                                            `<option value="${period}" ${h.periodo === period ? "selected" : ""}>${period}</option>`
                                        ).join("")}
                                    </select>
                                </td>
                                <td data-label="Area o Aerolinea">
                                    <input type="text" id="edit-aerolinea-${index}" class="form-control" value="${h.aerolinea || ""}" ${isEditable ? "" : "disabled"}>
                                </td>
                                <td data-label="Motivo">
                                    <input type="text" id="edit-motivo-${index}" class="form-control" value="${h.motivo || ""}" ${isEditable ? "" : "disabled"}>
                                </td>
                                <td data-label="Fecha">
                                    <input type="date" id="edit-date-${index}" class="form-control" value="${formattedDate}">
                                </td>
                                <td data-label="Hora Inicio">
                                    <input type="time" id="edit-time-${index}" class="form-control" value="${formattedTime}" onchange="updateFinalTime(${index})">
                                </td>
                                <td id="final-time-${index}" class="text-end" data-label="Hora Final">
                                    ${calculateFinalTime(formattedTime, h.horas || 0)}
                                </td>
                                <td id="subtotal-${index}" class="text-end" data-label="Subtotal">
                                    ${multiplicarValores(h.periodo ? h.periodo.replace(/[^0-9.,]/g, "").trim() : "0", h.horas)}
                                </td>
                            </tr>`;

                                        // Calcular el subtotal para cada fila y almacenarlo en miArray
                                        miArray.push(multiplicarValores(h.periodo ? h.periodo.replace(/[^0-9.,]/g, "").trim() : "0", h.horas));
                                    });

                                    // Calcular la suma total
                                    for (let i = 0; i < miArray.length; i++) {
                                        calcularSuma += miArray[i];
                                        console.log('Sumar array: ' + calcularSuma);
                                    }

                                    horasOptions += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <th id="total-hours">${totalHoras}</th>
                                <th colspan="5" class="text-end">Total Subtotal</th>
                                <th id="total-subtotal" class="text-end">${calcularSuma}</th>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="d-flex text-center">
                        <button id="save-changes" class="btn btn-primary">Guardar</button>
                        <button id="copy-summary" class="btn btn-secondary">Copiar</button>
                        <button id="cerrarInformeGenereal" onclick="cerrarInformeGenereal()" class="btn btn-secondary">Cerrar</button>
                    </div>
                    <br>
                </div>`;

                                    document.getElementById("cargarDetalles").innerHTML = horasOptions;

                                    document.getElementById("save-changes").onclick = function () {
                                        salvarCambios(horas, userId, name); // Pasar horas y userId
                                    };

                                    document.getElementById('copy-summary').addEventListener('click', () => {
                                        const summary = getSummaryText();
                                        copyToClipboard(summary);
                                    });
                                }
                            });
                    }
                })
                .catch((error) => {
                    if (error !== "cancelado") {
                        Swal.fire("Error", error, "error");
                    }
                });
        }

        function updateSubtotal(index) {
            const horasInput = document.getElementById(`edit-hours-${index}`);
            const periodSelect = document.getElementById(`edit-period-${index}`);
            const horas = parseFloat(horasInput.value) || 0;
            const period = periodSelect.value;

            const rate = periodRates[period] || 0;
            const subtotal = horas * rate;

            document.getElementById(`subtotal-${index}`).innerText = subtotal.toFixed(2);
            updateTotal();
        }

        function updateTotal() {
            let totalHoras = 0;
            let totalSubtotal = 0;

            // Sumar las horas y subtotales de todas las filas
            const rows = document.querySelectorAll('#hours-table-body tr');
            rows.forEach((row, index) => {
                const horas = parseFloat(document.getElementById(`edit-hours-${index}`).value) || 0;
                const subtotal = parseFloat(document.getElementById(`subtotal-${index}`).innerText) || 0;

                totalHoras += horas;
                totalSubtotal += subtotal;
            });

            // Actualizar los totales en la tabla
            document.getElementById('total-hours').innerText = totalHoras;
            document.getElementById('total-subtotal').innerText = totalSubtotal.toFixed(2);
        }





        function multiplicarValores(valor1, valor2) {
            // Convertir los valores a enteros
            const num1 = parseInt(valor1);
            const num2 = parseInt(valor2);

            // Realizar la multiplicación
            return num1 * num2;
        }

        function sumar(a, b) {
            return parseInt(a) + parseInt(b);
        }



        function salvarCambios(horas, userId, name) {

            const updatedHours = horas.map((h, index) => {
                const updatedHoras = parseFloat(document.getElementById(`edit-hours-${index}`).value) || 0;
                const updatedPeriodo = document.getElementById(`edit-period-${index}`).value;
                const updatedFecha = document.getElementById(`edit-date-${index}`).value;
                const updatedHoraInicio = document.getElementById(`edit-time-${index}`).value;
                const updatedMotivo = document.getElementById(`edit-motivo-${index}`).value || h
                    .motivo; // Si no existe el campo, usa el valor original
                const updatedAerolínea = document.getElementById(`edit-aerolinea-${index}`).value || h
                    .aerolinea; // Si no existe el campo, usa el valor original

                return {
                    horas: updatedHoras,
                    periodo: updatedPeriodo,
                    fecha: updatedFecha,
                    hora: updatedHoraInicio,
                    motivo: updatedMotivo,
                    aerolinea: updatedAerolínea,
                };
            });

            const userRef = doc(db, "usuarios", userId);
            updateDoc(userRef, {
                horas: updatedHours
            })
                .then(() => {
                    reproducirAudio();
                    Swal.fire("Guardado", "Los cambios se han guardado correctamente", "success");
                    showEditHoursModal(userId, name);
                })
                .catch((error) => {
                    console.error("Error al guardar los cambios:", error);
                    Swal.fire("Error", "No se pudieron guardar los cambios", "error");
                });
        }

        function calculateFinalTime(startTime, hoursToAdd) {
            const startDate = new Date(`1970-01-01T${startTime}:00Z`);
            startDate.setHours(startDate.getHours() + parseInt(hoursToAdd));

            const finalTime = startDate.toISOString().split('T')[1].substring(0, 5); // Formato HH:MM
            return finalTime;
        }

        function updateFinalTime(index) {
            const startTime = document.getElementById(`edit-time-${index}`).value;
            const hoursToAdd = document.getElementById(`edit-hours-${index}`).value;
            const finalTime = calculateFinalTime(startTime, hoursToAdd);
            document.getElementById(`final-time-${index}`).textContent = finalTime;
        }

        function getSummaryText() {
            let summary =
                "Fecha\t  Horas\t Inicio\t   Fin\t Motivo\t     Aerolínea\t Periodo\t    Subtotal\n"; // Encabezados con periodo incluido

            const rows = document.querySelectorAll('#hours-table-body tr');

            rows.forEach((row, index) => {
                const date = document.getElementById(`edit-date-${index}`).value.trim();
                const hours = document.getElementById(`edit-hours-${index}`).value.trim();
                const time = document.getElementById(`edit-time-${index}`).value.trim();
                const finalTime = document.getElementById(`final-time-${index}`).textContent.trim();
                const motivo = document.getElementById(`edit-motivo-${index}`).value.trim();
                const aerolinea = document.getElementById(`edit-aerolinea-${index}`).value.trim();
                const periodo = document.getElementById(`edit-period-${index}`).value.trim(); // Captura el periodo del select
                const subtotal = `₡${document.getElementById(`subtotal-${index}`).textContent.trim()}`;

                // Añadimos la fila al resumen con el periodo
                summary += `${date}\t${hours}\t${time}\t${finalTime}\t${motivo}\t${aerolinea}\t${periodo}\t${subtotal}\n`;
            });

            const totalHours = document.getElementById('total-hours').textContent.trim();
            const totalSubtotal = `₡${document.getElementById('total-subtotal').textContent.trim()}`;

            // Añadimos la fila total al resumen
            summary += `\nTotal Horas:\t${totalHours}\t\t\t\t\t\tTotal Subtotal:\t${totalSubtotal}`;

            return summary;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => {
                    Swal.fire("Copiado", "El resumen ha sido copiado al portapapeles", "success");
                })
                .catch(() => {
                    Swal.fire("Error", "No se pudo copiar al portapapeles", "error");
                });
        }

        function showPeriodDetails(index, horas, periodo, fecha, hora) {
            Swal.fire({
                title: `Detalles de la Hora ${index + 1}`,
                html: `
      <p><strong>Horas:</strong> ${horas}</p>
      <p><strong>Periodo:</strong> ${periodo}</p>
      <p><strong>Fecha:</strong> ${fecha}</p>
      <p><strong>Hora Inicio:</strong> ${hora}</p>
    `,
                icon: "info",
                confirmButtonText: "Cerrar",
            });
        }
        async function updateHoursForUser(userId, updatedHours) {
            try {
                const userRef = doc(db, "usuarios", userId);
                await updateDoc(userRef, {
                    horas: updatedHours
                });

                Swal.fire("Éxito", "Horas extra actualizadas correctamente", "success");
                cargarDatos(); // Refresca la tabla
            } catch (error) {
                console.error("Error al actualizar las horas: ", error);
                Swal.fire("Error", "No se pudieron actualizar las horas extra", "error");
            }
        }

        function showAddUserModal() {
            Swal.fire({
                title: "Agregar Nuevo Usuario",
                html: `
      <div class="form-group">
        <label for="userName">Nombre:</label>
        <input type="text" id="userName" class="form-control" placeholder="Ingresa el nombre del usuario">
      </div>
      <div class="form-group mt-3">
        <label for="userPassword">Contraseña:</label>
        <input type="password" id="userPassword" class="form-control" placeholder="Ingresa la contraseña">
      </div>
      <div class="form-group mt-3">
        <label for="userCedula">Número de Cédula:</label>
        <input type="text" id="userCedula" class="form-control" placeholder="Ingresa el número de cédula">
      </div>
    `,
                confirmButtonText: "Agregar",
                showCancelButton: true,
                preConfirm: () => {
                    const userName = document.getElementById("userName").value.trim();
                    const userPassword = document.getElementById("userPassword").value.trim();
                    const userCedula = document.getElementById("userCedula").value.trim();

                    if (!userName || !userPassword || !userCedula) {
                        Swal.showValidationMessage("Por favor, completa todos los campos");
                        return false;
                    }

                    return {
                        name: userName,
                        password: userPassword,
                        cedula: userCedula
                    };
                },
            }).then((result) => {
                if (result.isConfirmed) {
                    const {
                        name,
                        password,
                        cedula
                    } = result.value;
                    addUser(name, password, cedula);
                }
            });
        }

        function showHoursModal(userId, userName) {

const now = new Date();
const horaActuales = now.getHours().toString().padStart(2, '0'); // Asegura dos dígitos para la hora
const minutes = now.getMinutes().toString().padStart(2, '0'); // Asegura dos dígitos para los minutos
const currentTimehoraActual = `${horaActuales}:${minutes}`; // Formato HH:MM


// Obtén la fecha actual
const today = new Date();
const year = today.getFullYear();
const month = (today.getMonth() + 1).toString().padStart(2, '0'); // Asegura dos dígitos para el mes
const day = today.getDate().toString().padStart(2, '0'); // Asegura dos dígitos para el día
const currentDate = `${year}-${month}-${day}`; // Formato YYYY-MM-DD



Swal.fire({
    title: 'Ingrese su Contraseña',
    input: 'password',
    inputPlaceholder: 'Escribe tu contraseña',
    showCancelButton: true, // Mostrar el botón Cancelar
    confirmButtonText: 'Ingresar',
    cancelButtonText: 'Cancelar',
    
    preConfirm: (password) => {
        return new Promise((resolve, reject) => {
            const userRef = doc(db, "usuarios", userId);
            getDoc(userRef)
                .then((userDoc) => {
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        const storedPassword = userData.contraseya;

                        if (password.trim() === storedPassword.trim()) {
                            resolve();
                        } else {
                            reject("Contraseña incorrecta");
                        }
                    } else {
                        reject("Usuario no encontrado");
                    }
                })
                .catch(() => {
                    reject("Error al verificar la contraseña");
                });
        });
    }, 

    
}).then((result) => {
    if (result.isConfirmed) {
        Swal.fire({
            title: `Agregar Horas Extra para ${userName}`,
            showCloseButton: true,
            showCancelButton: true, // Mostrar el botón Cancelar
            confirmButtonText: 'Guardar',
            cancelButtonText: 'Cancelar',
            html: `
        <div  id="cajaHoras01">
                <div>
                    <label for="swal-hours" class="form-label">Selecciona las horas trabajadas</label>
                    <select id="swal-hours" class="form-select" aria-label="Selecciona las horas trabajadas">
                        <option value="" selected>Selecciona las horas trabajadas</option>
                        ${Array.from({ length: 24 }, (_, i) => `<option value="${i}">${i}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label for="swal-minutes" class="form-label">Selecciona los minutos trabajados</label>
                    <select id="swal-minutes" class="form-select" aria-label="Selecciona los minutos trabajados">
                        <option value="" selected>Selecciona los minutos trabajados</option>
                        ${Array.from({ length: 60 }, (_, i) => `<option value="${i}">${i}</option>`).join('')}
                    </select>
            
            </div>
       </div>
     
     <div  id="cajaHoras02" >
            <label for="swal-period" class="form-label">¿En que turno te toco trabajar?</label>
            <select id="swal-period" class="form-select" aria-label="¿En que turno te toco trabajar?">
                <option value="" selected>¿En que turno te toco trabajar?</option>          
                <option value="Diurna ₡2241.31">Diurnas ₡2241.31 (5:00am a las 19:00pm)</option>
                <option value="Mixta ₡2561.50">Mixtas ₡2561.50 (19:00 a las 22:00)</option>
                <option value="Nocturna ₡2988.41">Nocturnas ₡2988.41 (22:00 a las 5:00am)</option>
            </select>
          
        </div>
     <div  id="cajaHoras03"   >
            <label for="swal-start-time" class="form-label">¿Cuál fue la hora que iniciaste el trabajo?</label>
                    
            <input type="time" id="swal-start-time" class="form-control" aria-label="Hora de inicio">
           
    </div>
  <div  id="cajaHoras04" >
            <label for="swal-date" class="form-label">Actualiza la fecha en que trabajaste</label>
            <input type="date" id="swal-date" class="form-control" aria-label="Fecha">
        
        </div>
        <div  id="cajaHoras05" >
            <label for="swal-airline" class="form-label">Area o Aerolínea</label>
            <select id="swal-airline" class="form-select" aria-label="Selecciona la aerolínea">
                <option value="" selected>Selecciona area o aerolínea</option>
                <option value="Terminal">Terminal</option>
                <option value="Recibir Equipaje">Recibir Equipaje</option>
                <option value="Arajet">Arajet</option>
                <option value="Edelweiss Air">Edelweiss Air</option>
                <option value="Air Transat">Air Transat</option>
                <option value="Frontier">Frontier</option>
                <option value="Evelop">Evelop</option>
                <option value="Iberojet">Iberojet</option>
                <option value="Lufthansa">Lufthansa</option>
                    <option value="Olvide la aerolinea">Olvide la aerolinea</option>
            </select>
           
        </div>
      <div  id="cajaHoras06" >
            <label for="swal-reason" class="form-label">Motivo de la Extra</label>
            <select id="swal-reason" class="form-select" aria-label="Selecciona el motivo">
                <option value="Poco personal">Me llamaron para cubrir counter</option>
                <option value="Poco personal">Me llamaron para recibir un vuelo</option>
                <option value="Vuelo demorado">Vuelo demorado</option>
                <option value="Se ocupó más tiempo para cubrir la tarea">Se ocupó más tiempo para cubrir la tarea</option>
                <option value="Capacitación">Capacitación</option>
                <option value="Cubrir personal">Cubrir personal ausente</option>
                <option value="Poco personal">Poco personal</option>
                <option value="No es una extra" >No es una extra</option>
            </select>
         
        </div>

            
    `,
            didOpen: () => {
                // Configura el valor predeterminado del input
                const timeInput = document.getElementById('swal-start-time');
                if (timeInput) {
                    timeInput.value = currentTimehoraActual;
                }

                const dateInput = document.getElementById('swal-date');
                if (dateInput) {
                    dateInput.value = currentDate;
                }
            },
            preConfirm: () => {
                const hours = document.getElementById("swal-hours").value.trim();
                const minutes = document.getElementById("swal-minutes").value.trim();
                const period = document.getElementById("swal-period").value;
                const startTime = document.getElementById("swal-start-time").value;
                const date = document.getElementById("swal-date").value;
                const airline = document.getElementById("swal-airline").value;
                const reason = document.getElementById("swal-reason").value;

                if (!hours || isNaN(hours) || hours < 0) {
                    Swal.showValidationMessage("Por favor, ingresa un número válido de horas");
                    return false;
                }

                if (!minutes || isNaN(minutes) || minutes < 0 || minutes >= 60) {
                    Swal.showValidationMessage("Por favor, ingresa un número válido de minutos");
                    return false;
                }

                if (!period) {
                    Swal.showValidationMessage("Por favor, selecciona un periodo");
                    return false;
                }

                if (!startTime) {
                    Swal.showValidationMessage("Por favor, ingresa una hora de inicio");
                    return false;
                }

                if (!date) {
                    Swal.showValidationMessage("Por favor, selecciona una fecha");
                    return false;
                }

                if (!airline) {
                    Swal.showValidationMessage("Por favor, selecciona una aerolínea");
                    return false;
                }

                if (!reason) {
                    Swal.showValidationMessage("Por favor, selecciona un motivo");
                    return false;
                }

                return {
                    hours,
                    minutes,
                    period,
                    startTime,
                    date,
                    airline,
                    reason,
                };
            },
        }).then((result) => {
            if (result.isConfirmed) {
                const { hours, minutes, period, startTime, date, airline, reason } = result.value;
                console.log(`ID: ${userId}, Horas: ${hours}, Minutos: ${minutes}, Periodo: ${period}, Hora de inicio: ${startTime}, Fecha: ${date}, Aerolínea: ${airline}, Motivo: ${reason}`);
                addHoursToUser(userId, hours, minutes, period, startTime, date, airline, reason);
            }
        });
    }
}).catch((error) => {
    Swal.fire("Error", error, "error");
});
}

function addHoursToUser(userId, hours, minutes, period, startTime, date, airline, reason) {
            const totalMinutes = (parseInt(hours) * 60) + parseInt(minutes);
            const endTime = calculateEndTime(startTime, totalMinutes);

            const userRef = doc(db, "usuarios", userId);

            const newEntry = {
                horas: hours,
                minutos: minutes,
                periodo: period,
                horaInicio: startTime,
                horaFin: endTime,
                fecha: date,
                aerolinea: airline,
                motivo: reason
            };

            updateDoc(userRef, {
                horas: arrayUnion(newEntry) // Agrega el nuevo objeto al array "horas"
            }).then(() => {
                Swal.fire("Éxito", "Las horas extra han sido agregadas correctamente", "success");
            }).catch((error) => {
                console.error("Error al agregar las horas extra:", error);
                Swal.fire("Error", "Hubo un problema al agregar las horas extra", "error");
            });
        }

        function calculateEndTime(startTime, totalMinutes) {
            const [startHours, startMinutes] = startTime.split(":").map(Number);
            const totalStartMinutes = (startHours * 60) + startMinutes;
            const endMinutes = totalStartMinutes + totalMinutes;
            const endHours = Math.floor(endMinutes / 60) % 24;
            const endMinutesMod = endMinutes % 60;

            return `${String(endHours).padStart(2, "0")}:${String(endMinutesMod).padStart(2, "0")}`;
        }




        async function deleteUser() {
            try {
                const querySnapshot = await getDocs(collection(db, "usuarios"));
                let userListHTML = '<ul style="list-style: none; padding: 0;">';

                querySnapshot.forEach((doc) => {
                    userListHTML += `
        <li style="margin-bottom: 10px;">
          <span>${doc.data().name}</span>
          <button class="btn btn-danger btn-sm" style="margin-left: 10px;" onclick="confirmDeleteUser('${doc.id}', '${doc.data().name}')">
            Eliminar
          </button>
        </li>
      `;
                });

                userListHTML += '</ul>';

                await Swal.fire({
                    title: "Seleccionar Usuario para Eliminar",
                    html: userListHTML,
                    showCloseButton: true,
                    showConfirmButton: false, // No necesitamos el botón de confirmar general
                });
            } catch (e) {
                console.error("Error al cargar usuarios para eliminar: ", e);
                Swal.fire("Error", "Hubo un problema al cargar los usuarios.", "error");
            }
        }

        async function confirmDeleteUser(userId, userName) {
            try {
                const confirmation = await Swal.fire({
                    title: `¿Eliminar a ${userName}?`,
                    text: "Esta acción no se puede deshacer.",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Sí, eliminar",
                    cancelButtonText: "Cancelar",
                });

                if (confirmation.isConfirmed) {
                    await deleteDoc(doc(db, "usuarios", userId));
                    Swal.fire("Eliminado", `${userName} ha sido eliminado correctamente.`, "success");
                    //   showDeleteUserModal(); // Actualizar la lista
                    cargarDatos(); // Actualizar la tabla principal
                }
            } catch (e) {
                console.error("Error al eliminar usuario: ", e);
                Swal.fire("Error", "No se pudo eliminar el usuario.", "error");
            }
        }



        async function fetchUsers() {
            showLoading(); // Mostrar indicador de carga
            try {
                const tableBody = document.getElementById("user-table-body");
                tableBody.innerHTML = ""; // Limpiar la tabla

                const querySnapshot = await getDocs(collection(db, "usuarios"));
                querySnapshot.forEach((doc) => {
                    const horas = Array.isArray(doc.data().horas) ?
                        doc.data().horas
                            .map(
                                (h, index) =>
                                    `${h.horas} (${h.periodo}) - ${new Date(h.fecha).toLocaleString()} `
                            )
                            .join("<br>") :
                        "No hay horas registradas"; // Mostrar las horas registradas

                    const row = document.createElement("tr");
                    row.innerHTML = `
        <td>${doc.id}</td>
        <td>${doc.data().name}</td>
        <td>${doc.data().contraseya}</td>
        <td>${doc.data().cedula}</td>  <!-- Mostrar el número de cédula -->
        <td>
           <button class="btn btn-primary" onclick="showEditHoursModal('${doc.id}', '${doc.data().name}')">Resumen</button>
        </td>
        <td>
          <button class="btn btn-warning" onclick="showHoursModal('${doc.id}', '${doc.data().name}')">Insertar horas</button>
          <button class="btn btn-danger" onclick="deleteUser('${doc.id}')">Eliminar</button>
        </td>
      `;

                    tableBody.appendChild(row);
                });
            } catch (e) {
                console.error("Error al obtener documentos: ", e);
                Swal.fire("Error", "Hubo un problema al cargar los usuarios.", "error");
            } finally {
                Swal.close(); // Cerrar indicador de carga
            }
        }


        function continuarDescarga() {
    console.log('continuarDescarga');
    Swal.close();

    // Crear el dropdown para las opciones
    const opcionesDropdown = `
        <ul id="menuopcionesDropdown" class="mb-3">
            <li class="nav-item btn btn-primary" onclick="deleteUser()" ><i class="fa fa-trash" aria-hidden="true"></i></a></li>
            <li class="nav-item btn btn-primary" id="btnCopiarResumen" ><a class="nav-link" href="#"><i class="fa fa-clone" aria-hidden="true"></i></a></li>
            <li class="nav-item btn btn-primary" id="btnDescargarPDF" ><a class="nav-link" href="#">PDF</a></li>
            <li class="nav-item btn btn-primary" onclick="limpiarHoras()"><a class="nav-link" id="btnLimpiar" href="#"><i class="fa fa-hourglass-half" aria-hidden="true"></i></a></li>
            <li class="nav-item btn btn-primary" id="btnCerrarInforme">
                <a class="nav-link" href="#"><i class="fa fa-window-close" aria-hidden="true"></i></a>
            </li>
        </ul>
    `;

    // Insertar el dropdown encima de la tabla
    document.getElementById("usuariosTable").insertAdjacentHTML('beforebegin', opcionesDropdown);

    getDocs(collection(db, "usuarios"))
        .then((querySnapshot) => {
            let usuariosData = "";

            querySnapshot.forEach((doc) => {
                const usuario = doc.data();
                const nombre = (usuario.name || "Sin nombre").toUpperCase();
                const cedula = (usuario.cedula || "Sin cédula").toUpperCase();
                const horas = usuario.horas || [];

                let totalHoras = 0;
                let totalMonto = 0;

                let filasHoras = horas.map((h) => {
                    const fecha = h.fecha ? h.fecha : "Sin fecha";
                    const horaInicio = h.horaInicio || "Sin hora";
                    const horaFin = h.horaFin || "Sin hora fin";
                    const cantidadHoras = parseFloat(h.horas) || 0; // Asegurarse de que sea un número
                    const aerolinea = h.aerolinea || "Sin aerolínea";
                    const motivo = h.motivo || "Sin motivo";
                    const periodo = h.periodo || "Sin periodo";

                    // Cálculo de hora fin a partir de horaInicio + horas
                    let horaInicioDate = new Date(`2025-01-12T${horaInicio}:00`); // Usa la fecha del día + hora de inicio
                    let horaFinDate = new Date(horaInicioDate.getTime() + (cantidadHoras * 60 * 60 * 1000)); // Sumar horas

                    const horaFinFormat = `${horaFinDate.getHours().toString().padStart(2, "0")}:${horaFinDate.getMinutes().toString().padStart(2, "0")}`;

                    // Calcular monto de acuerdo con el periodo
                    let monto = 0;
                    const periodoParts = periodo.match(/₡([\d,\.]+)/);
                    if (periodoParts && periodoParts[1]) {
                        monto = parseFloat(periodoParts[1].replace(',', ''));
                    }

                    const subtotal = cantidadHoras * monto;

                    totalHoras += cantidadHoras;
                    totalMonto += subtotal;

                    return `
                        <tr>
                            <td>${cantidadHoras}</td>
                            <td>${periodo}</td>
                            <td>${fecha}</td>
                            <td>${horaInicio}</td>
                            <td>${horaFinFormat}</td>
                            <td>${aerolinea}</td>
                            <td>${motivo}</td>
                            <td>₡${subtotal.toFixed(2)}</td>
                        </tr>
                    `;
                }).join("");

                usuariosData += `
                    <div class="container p-2">
                        <h2>${nombre} - Cédula: ${cedula}</h2>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Horas</th>
                                    <th>Periodo</th>
                                    <th>Fecha</th>
                                    <th>Hora Inicio</th>
                                    <th>Hora Fin</th>
                                    <th>Aerolínea</th>
                                    <th>Motivo</th>
                                    <th>Subtotal (Horas x Monto)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filasHoras}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th>${totalHoras.toFixed(2)}</th>
                                    <th></th>
                                    <th colspan="4"></th>
                                    <th>Subtotal General</th>
                                    <th>₡${totalMonto.toFixed(2)}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
            });

            document.getElementById("usuariosTable").innerHTML = usuariosData;
            document.getElementById("misUsuarios").style.display = "none";
            document.getElementById("usuariosTable").style.display = "block";

            // Eventos
            document.getElementById("btnCopiarResumen").addEventListener("click", () => {
                const resumen = generateSummary(querySnapshot);
                navigator.clipboard.writeText(resumen)
                    .then(() => Swal.fire("¡Éxito!", "Resumen copiado al portapapeles", "success"))
                    .catch(() => Swal.fire("Error", "No se pudo copiar el resumen", "error"));
            });

            document.getElementById("btnCerrarInforme").addEventListener("click", cerrarModal);
            document.getElementById("btnDescargarPDF").addEventListener("click", descargarPDF);
        })
        .catch((error) => {
            console.error("Error al cargar los usuarios:", error);
            Swal.fire("Error", "No se pudieron cargar los datos de los usuarios", "error");
        });
}


        function truncate(str, num) {
            const capitalize = (s) =>
                s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();

            // Capitalizar cada palabra
            const capitalizedStr = str
                .split(" ")
                .map(capitalize)
                .join(" ");

            // Truncar la cadena si excede la longitud
            if (capitalizedStr.length > num) {
                return capitalizedStr.slice(0, num) + "...";
            } else {
                return capitalizedStr;
            }
        }


        function descargar() {
            // Obtener la contraseña guardada en localStorage
            const contrasenaGuardada = localStorage.getItem('contraseña');
            console.log(contrasenaGuardada);

            // Si la contraseña está guardada y es correcta, continuar con el proceso
            if (contrasenaGuardada === 'vale123') {
                continuarDescarga();
            } else {
                console.log('entre');
                // Si la contraseña no está guardada o es incorrecta, solicitarla
                Swal.fire({
                    title: 'Por favor ingrese la contraseña',
                    input: 'password', // El tipo de entrada es 'password' para ocultar los caracteres
                    inputPlaceholder: 'Ingrese la contraseña',
                    showCancelButton: false, // No mostrar el botón de cancelar
                    confirmButtonText: 'Aceptar',
                    inputValidator: (value) => {
                        if (value === 'vale123') {
                            localStorage.setItem('contraseña',
                                'vale123'); // Guardar la contraseña en localStorage
                            continuarDescarga(); // Si la contraseña es correcta, continuar con la descarga
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Contraseña incorrecta',
                                text: 'La contraseña ingresada es incorrecta.',
                            });
                        }
                    }
                });


            }
        }

        async function limpiarHoras() {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1; // Mes actual (1-12)
            const previousMonth = currentMonth === 1 ? 12 : currentMonth - 1; // Mes anterior
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

            const monthNames = [
                "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
            ];

            let dayOptions = '';
            for (let i = 1; i <= daysInMonth; i++) {
                dayOptions += `<option value="${i}">${i}</option>`;
            }

            Swal.fire({
                title: '¿En qué fecha inicia esta quincena?',
                html: `
      <div class="text-center">
        <p style="margin-bottom: 20px; color: #333; font-size: 14px;">
          Esta opción eliminará los valores insertados antes de la fecha indicada.
        </p>
        
        <div class="form-check">
          <input class="form-check-input" type="radio" id="mesAnterior" name="mesSelector" value="${previousMonth}">
          <label class="form-check-label" for="mesAnterior">${monthNames[previousMonth - 1]}</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" id="mesActual" name="mesSelector" value="${currentMonth}" checked>
          <label class="form-check-label" for="mesActual">${monthNames[currentMonth - 1]}</label>
        </div>
        <label for="dia" style="font-weight: bold; display: block; margin-bottom: 10px;">Selecciona el día:</label>
        <select id="dia" class="form-select" style="width: auto; margin: 0 auto;">
          ${dayOptions}
        </select>
      </div>
    `,
                confirmButtonText: 'Eliminar',
                cancelButtonText: 'Cancelar',
                showCancelButton: true,
                header: `<strong>Año actual: ${currentYear}</strong>`,
                preConfirm: () => {
                    const dia = document.getElementById('dia').value;
                    const mes = document.querySelector('input[name="mesSelector"]:checked').value;

                    if (!dia || !mes) {
                        Swal.showValidationMessage("Por favor selecciona todos los campos.");
                        return false;
                    }

                    return `${currentYear}-${mes.toString().padStart(2, '0')}-${dia.toString().padStart(2, '0')}`;
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const fechaLimite = new Date(result.value); // Fecha límite seleccionada por el usuario

                    try {
                        const querySnapshot = await getDocs(collection(db, "usuarios"));

                        const batch = writeBatch(db); // Usar batch para operaciones en lote

                        querySnapshot.forEach((docSnapshot) => {
                            const usuario = docSnapshot.data();
                            const horas = usuario.horas || []; // Acceder a las horas

                            // Filtrar horas que sean posteriores o iguales a la fecha límite
                            const horasActualizadas = horas.filter((hora) => {
                                const fechaHora = new Date(hora
                                    .fecha); // Convertir fecha a objeto Date
                                return fechaHora >=
                                    fechaLimite; // Mantener horas posteriores o iguales a la fecha límite
                            });

                            if (horas.length !== horasActualizadas.length) {
                                const usuarioRef = doc(db, "usuarios", docSnapshot.id);
                                batch.update(usuarioRef, {
                                    horas: horasActualizadas
                                }); // Actualizar en lote
                            }
                        });

                        await batch.commit(); // Confirmar los cambios
                        Swal.fire("¡Éxito!", "Horas eliminadas correctamente.", "success").then((
                            result) => {
                            if (result.isConfirmed) {
                                // Recargar la página
                                location.reload();
                            }
                        });

                    } catch (error) {
                        console.error("Error al eliminar las horas: ", error);
                        Swal.fire("Error", "Hubo un problema al eliminar las horas.", "error");
                    }
                }
            });
        }

        function descargarExcel() {
            Swal.fire({
                title: 'Cargando...',
                text: 'Estamos cargando los datos desde Firebase',
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Llamar a la función para obtener los datos desde Firebase
            getDocs(collection(db, "usuarios"))
                .then((querySnapshot) => {
                    // Crear una nueva tabla HTML para mostrar los datos
                    const usuariosTable = document.createElement("table");
                    let usuariosHTML =
                        `<thead><tr><th>Nombre</th><th>Cédula</th><th>Email</th><th>Fecha</th><th>Hora</th><th>Horas</th><th>Periodo</th><th>Subtotal</th></tr></thead><tbody>`;

                    querySnapshot.forEach((doc) => {
                        const usuario = doc.data();
                        const nombre = usuario.name || "Sin nombre";
                        const cedula = usuario.cedula || "Sin cédula";
                        const email = usuario.email || "Sin email";
                        const horas = usuario.horas || [];

                        // Iterar sobre las horas del usuario
                        horas.forEach((horaData) => {
                            const fecha = horaData.fecha || "Sin fecha";
                            const hora = horaData.hora || "Sin hora";
                            const horasTrabajadas = horaData.horas || 0;
                            const periodo = horaData.periodo || "Sin periodo";
                            const subtotal = horaData.subtotal || 0;

                            // Agregar una fila a la tabla con la información de cada hora
                            usuariosHTML += `
            <tr>
              <td>${nombre}</td>
              <td>${cedula}</td>
              <td>${email}</td>
              <td>${fecha}</td>
              <td>${hora}</td>
              <td>${horasTrabajadas}</td>
              <td>${periodo}</td>
              <td>${subtotal}</td>
            </tr>
          `;
                        });
                    });

                    usuariosHTML += `</tbody>`;
                    usuariosTable.innerHTML = usuariosHTML;

                    // Usar la librería XLSX para convertir la tabla HTML en un libro de trabajo Excel
                    const wb = XLSX.utils.table_to_book(usuariosTable, {
                        sheet: "Usuarios"
                    });

                    // Descargar el archivo Excel
                    XLSX.writeFile(wb, "usuarios.xlsx");

                    // Cerrar el mensaje de carga
                    Swal.close();

                    // Mensaje de éxito
                    Swal.fire("¡Éxito!", "Archivo Excel descargado correctamente", "success");
                })
                .catch((error) => {
                    console.error("Error al cargar los usuarios desde Firebase:", error);

                    // Cerrar el mensaje de carga
                    Swal.close();

                    // Mensaje de error
                    Swal.fire("Error", "Hubo un problema al obtener los datos desde Firebase", "error");
                });
        }

        function descargarPDF() {
            const {
                jsPDF
            } = window.jspdf;
            const doc = new jsPDF();
            const usuariosTable = document.getElementById("usuariosTable");

            // Agregar títulos al PDF
            const titulo = "GSG";
            const titulo2 = "Registro de Horas Extras";
            const fecha = new Date().toLocaleDateString(); // Fecha actual en formato local

            doc.setFontSize(16); // Tamaño del título principal
            doc.text(titulo, 10, 10); // Título principal en la posición (10, 10)
            doc.setFontSize(14); // Tamaño del segundo título
            doc.text(titulo2, 10, 20); // Segundo título en la posición (10, 20)

            // Agregar fecha al lado derecho
            doc.setFontSize(12); // Tamaño de la fecha
            const pageWidth = doc.internal.pageSize.getWidth(); // Obtener ancho de la página
            doc.text(`Fecha: ${fecha}`, pageWidth - 50, 20); // Fecha alineada a la derecha

            // Agregar firmas en una sola línea
            const firmaPositionY = 30; // Posición vertical del texto
            const lineOffsetY = 3; // Desplazamiento de la línea hacia abajo desde el texto
            doc.setFontSize(10); // Tamaño de texto para las firmas
            doc.text("Firma del Supervisor:", 10, firmaPositionY); // Texto de la firma del supervisor
            doc.line(50, firmaPositionY + lineOffsetY, 100, firmaPositionY +
                lineOffsetY); // Línea para la firma del supervisor
            doc.text("Firma de Revisado:", 110, firmaPositionY); // Texto de la firma de revisado
            doc.line(150, firmaPositionY + lineOffsetY, 200, firmaPositionY +
                lineOffsetY); // Línea para la firma de revisado

            // Usar html2canvas para capturar el contenido
            html2canvas(usuariosTable)
                .then((canvas) => {
                    const imgData = canvas.toDataURL("image/png"); // Convertir canvas a imagen
                    const imgWidth = 190; // Ajusta el ancho según el tamaño del PDF
                    const imgHeight = (canvas.height * imgWidth) / canvas.width; // Escalar la altura proporcionalmente
                    let position = firmaPositionY + 15; // Ajustar posición después de las firmas

                    doc.addImage(imgData, "PNG", 10, position, imgWidth, imgHeight); // Agregar imagen al PDF
                    doc.save("informe_usuarios.pdf"); // Descargar el PDF
                })
                .catch((error) => {
                    console.error("Error al generar el PDF:", error);
                    Swal.fire("Error", "No se pudo generar el PDF", "error");
                });
        }

        function cerrarModal() {

            location.reload();
            /*

            document.getElementById("misUsuarios").style.display = "block"; 
            document.getElementById("usuariosTable").style.display = "none"; 
            document.getElementById("menuopcionesDropdown").style.display = "none"; 
             */
        }

        function generateSummary(querySnapshot) {
            let summary = "";

            querySnapshot.forEach((doc) => {
                const usuario = doc.data();
                const usuarioNombre = usuario.name || "Sin nombre";
                const cedula = usuario.cedula || "Sin cédula";
                const horas = usuario.horas || [];

                summary += `Nombre: ${usuarioNombre}\nCédula: ${cedula}\n\n`;
                summary += "Fecha\tHoras\tInicio\tFin\t    Subtotal\t     Período\t     Motivo\t    Aerolínea\n";

                let totalHorasUsuario = 0;
                let totalSubtUsuario = 0;

                horas.forEach((h) => {
                    const fecha = h.fecha ? new Date(h.fecha).toISOString().split("T")[0] : "Sin fecha";
                    const horaInicio = h.hora || "Sin hora";
                    const cantidadHoras = h.horas || 0;
                    const motivo = h.motivo || "Sin motivo";
                    const aerolinea = h.aerolinea || "Sin aerolínea";
                    let periodo = h.periodo || "Sin periodo";
                    let monto = 0;

                    try {
                        periodo = periodo.replace(/\s?\(.*\)\s?/g, "");
                        const periodoParts = periodo.match(/₡([\d,\.]+)/);
                        monto = periodoParts && periodoParts[1] ? parseFloat(periodoParts[1].replace(',',
                            '')) : 0;
                    } catch (error) {
                        console.error("Error procesando período:", error, periodo);
                    }

                    const subtotal = cantidadHoras * monto;
                    totalSubtUsuario += subtotal;
                    totalHorasUsuario += cantidadHoras;

                    let horaFin = "Sin hora fin";
                    if (horaInicio !== "Sin hora") {
                        const [hora, minutos] = horaInicio.split(":").map((e) => parseInt(e, 10));
                        const inicioDate = new Date(2000, 1, 1, hora, minutos);
                        inicioDate.setHours(inicioDate.getHours() + cantidadHoras);
                        const finHora = inicioDate.getHours().toString().padStart(2, "0");
                        const finMinutos = inicioDate.getMinutes().toString().padStart(2, "0");
                        horaFin = `${finHora}:${finMinutos}`;
                    }

                    summary +=
                        `${fecha}\t${cantidadHoras}\t${horaInicio}\t${horaFin}\t₡${subtotal.toFixed(2)}\t${periodo}\t${motivo}\t${aerolinea}\n`;
                });

                summary +=
                    `\nTotal Horas: ${totalHorasUsuario}\tTotal Subtotal: ₡${totalSubtUsuario.toFixed(2)}\n\n`;
            });

            return summary;
        }

        function registrarUsuario() {
            reproducirAudio();
            showAddUserModal();
            exit;

        }

        function menuPrincipal() {
            reproducirAudio();
            descargarAndCloseModal();


        }

        function frontier() {
            window.location.href = "https://chat.whatsapp.com/H5N0y9Hx8wcFRdiB1qRPYZ";
        }



        function reproducirAudio() {
            const ruta1 = 'sonidos/sonido1.mp3'; // Primera ruta
            const ruta2 = '../sonidos/sonido1.mp3'; // Segunda ruta

            // Función para probar si un archivo existe
            function probarRuta(ruta) {
                return new Promise((resolve) => {
                    const audio = new Audio(ruta);
                    audio.oncanplaythrough = () => resolve(true);
                    audio.onerror = () => resolve(false);
                });
            }

            // Probar la primera ruta, si falla, intentar la segunda
            probarRuta(ruta1).then((existeRuta1) => {
                const rutaSeleccionada = existeRuta1 ? ruta1 : ruta2;
                const audio = new Audio(rutaSeleccionada);
                audio.play().catch((error) =>
                    console.error('Error al reproducir el sonido:', error)
                );
            });
        }


        function reproducirAudioxxxx() {
            const audio = new Audio('sonidos/sonido1.mp3'); // Reemplaza con la ruta de tu archivo MP3
            audio.play().catch(error => console.error('Error al reproducir el sonido:', error));

        }

        // Función para agregar usuario y cerrar el modal
        function addUserAndCloseModal() {
            showAddUserModal(); // Llamas a la función que agregará al usuario
            Swal.close(); // Cierra el modal
        }

        // Función para descargar el informe y cerrar el modal
        function descargarAndCloseModal() {
            document.getElementById("titulo").style.display = "none";
            descargar(); // Llamas a la función de descarga
            // Swal.close();  // Cierra el modal
        }

        // Función para continuar la descarga y cerrar el modal



        function handleAction(action) {
            Swal.fire({
                icon: 'success',
                title: `${action} seleccionada`,
                text: `Has seleccionado la opción: ${action}`,
            });
        }

        function guardarContraseya() {
            // Usamos SweetAlert2 para pedir la contraseña
            Swal.fire({
                title: 'Ingresa la contraseña',
                input: 'password',
                inputPlaceholder: 'Escribe la contraseña',
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    // Si el valor ingresado es 'vale123', lo guardamos en el localStorage
                    if (value === 'vale123') {
                        localStorage.setItem('contraseña', 'vale123');
                        Swal.fire('Contraseña guardada!', 'La contraseña ha sido guardada en el caché.',
                            'success');
                    } else {
                        return 'Contraseña incorrecta!';
                    }
                }
            });
        }
        async function cargarHeader() {
            try {
                // Selecciona el elemento con ID "header"
                const header = document.getElementById("header");

                // Limpia cualquier contenido previo en el header
                header.innerHTML = "";

                // Inserta el contenido dinámico en el header
                header.innerHTML = `
            <i class="fa fa-book fa-2x text-primary" aria-hidden="true" onclick="menuPrincipal()" id="imgLogo"></i>
            <br><br>
            <i id="registrarUsuario" class="fa fa-user-plus fa-2x text-primary" aria-hidden="true" onclick="registrarUsuario()"></i>
            <br><br>
            <a href="https://wa.me"><i class="fa fa-whatsapp fa-2x" aria-hidden="true"></i></a>
            <br><br>
            <div class="avatar" onclick="frontier()">  <img src="./img/frontier.png" alt="" width="30"></div>
        `;

                console.log("Header cargado correctamente.");
            } catch (e) {
                console.error("Error al cargar el header: ", e);
            }
        }


        window.cargarHeader = cargarHeader;
        window.frontier = frontier;
        window.reproducirAudio = reproducirAudio;
        window.confirmDeleteUser = confirmDeleteUser;
        window.registrarUsuario = registrarUsuario;
        window.addUserAndCloseModal = addUserAndCloseModal;
        window.descargarAndCloseModal = descargarAndCloseModal;
        window.guardarContraseya = guardarContraseya;
        window.continuarDescarga = continuarDescarga;
        window.limpiarHoras = limpiarHoras;
        window.menuPrincipal = menuPrincipal;
        window.cerrarInformeGenereal = cerrarInformeGenereal;
        window.showPeriodDetails = showPeriodDetails;
        window.descargar = descargar;
        window.showEditHoursModal = showEditHoursModal;
        window.deleteUser = deleteUser;
        window.cargarDatos = cargarDatos;
        window.showAddUserModal = showAddUserModal;
        window.showHoursModal = showHoursModal;
        window.onload = cargarDatos;
    </script>
</head>

<body>

    <div class="header" id="header">

    </div>
    <div class="container-fluid">
        <div id="titulo" class="card-title text-center">

            <img src="./img/logo.png" width="10%" class="animate__animated animate__backInDown ">
            <h2 class="animate__animated animate__backInDown text-primary">Aeropuerto Internacional </h2>
            <h2 class="animate__animated animate__backInDown text-primary"> Juan Santamaría </h2>
        </div>

        <div id="bodyDetalles" class="animate__animated animate__backInDown ">
            <div id="cargarDetalles">

            </div>
        </div>

        <div class="container">

            <div id="usuariosTable" class="container-fluid p-2" style=" width: 100% !important;">

            </div>

            <div id="success-message" class="alert alert-success" style="display: none;">
                Cambios guardados correctamente.
            </div>

        </div>

        <div class="container text-center animate__animated animate__backInDown">

            <div id="misUsuarios">

                <h5 class="text-primary">Horas Extras</h5>
                <!-- Tabla con la nueva columna para eliminar -->
                <table class="table mt-3">

                    <tbody id="user-table-body">
                        <!-- Los datos de usuarios se cargarán aquí -->
                    </tbody>
                </table>

            </div>
        </div>
    </div>

</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script type="text/javascript">
    emailjs.init('_l4EbnoapfSxp62zS')
</script>
<script src="./script.js"></script>

</html>